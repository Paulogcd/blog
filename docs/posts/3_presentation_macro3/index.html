<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Paulo Gugelmo Cavalheiro Dias">
<meta name="dcterms.date" content="2024-06-22">

<title>My Blog - Literature Review of natural hazards damages</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../projects"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../contact.html"> 
<span class="menu-text">Contact</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/Paulogcd/blog">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/Paulogcd/blog/issues">
            Report a Bug
            </a>
          </li>
      </ul>
    </div>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#wealth-inequality" id="toc-wealth-inequality" class="nav-link" data-scroll-target="#wealth-inequality">Wealth inequality</a></li>
  <li><a href="#natural-hazard-and-wealth-inequality" id="toc-natural-hazard-and-wealth-inequality" class="nav-link" data-scroll-target="#natural-hazard-and-wealth-inequality">Natural Hazard and Wealth Inequality</a></li>
  <li><a href="#research-design" id="toc-research-design" class="nav-link" data-scroll-target="#research-design">Research Design</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#measurement" id="toc-measurement" class="nav-link" data-scroll-target="#measurement">Measurement</a>
  <ul class="collapse">
  <li><a href="#wealth-trajectories" id="toc-wealth-trajectories" class="nav-link" data-scroll-target="#wealth-trajectories">Wealth Trajectories</a></li>
  <li><a href="#natural-hazard-damages" id="toc-natural-hazard-damages" class="nav-link" data-scroll-target="#natural-hazard-damages">Natural Hazard Damages</a></li>
  <li><a href="#other-key-variables" id="toc-other-key-variables" class="nav-link" data-scroll-target="#other-key-variables">Other Key Variables</a></li>
  <li><a href="#control-variables" id="toc-control-variables" class="nav-link" data-scroll-target="#control-variables">Control Variables</a></li>
  </ul></li>
  <li><a href="#sampling-and-modeling" id="toc-sampling-and-modeling" class="nav-link" data-scroll-target="#sampling-and-modeling">Sampling and Modeling</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Literature Review of natural hazards damages</h1>
  <div class="quarto-categories">
    <div class="quarto-category">economics</div>
    <div class="quarto-category">environment</div>
    <div class="quarto-category">natural hazard</div>
    <div class="quarto-category">environmental damage</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Paulo Gugelmo Cavalheiro Dias </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 22, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>This is a draft for our Macro3 presentation. Article : Junia Howell, James R. Elliott, Damages Done: The Longitudinal Impacts of Natural Hazards on Wealth Inequality in the United States, available <a href="https://academic.oup.com/socpro/article-abstract/66/3/448/5074453?redirectedFrom=fulltext">here</a>.</p>
<p>Summary (paragraph per paragraph)</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>1 - There exists rising wealth inequality. Economic research tries to explain it by (1) income, (2) differential in Return on Investment (RoI), (3) policies. Without rejecting those approaches, this paper tries to use natural hazard damages to explain wealth inequality.</p>
<p>2 - The main reasons to care about the effect of natural hazard on wealth inequalities are :</p>
<ul>
<li>its scale : it is very costly.</li>
<li>its scope : 99,7% of the US counties have been affected by it since 2000.</li>
<li>its trajectory : with optimistic scenarios, the damages from natural hazards are projected to at least double (or quadruple) in 2050.</li>
</ul>
<p>3 - Research already showed tha poor people recover less than rich from natural hazard, even in relative terms. Also, research underlines the key role of recovery resources, and not only physical damages received.</p>
<p>4 - Globally, there is a consensus on this literature about the importance of the relationships between natural hazard and pre-existing social inequalities, and not natural hazards alone.</p>
<p>5 - They first do a literature review, then perform an empirical study of the different causes of wealth inequalities, with the dataset from :</p>
<ul>
<li>PSID : 1993-2013, individual data.</li>
<li>SHELDUS : about natural hazard.</li>
<li>FEMA : about federal help against natural hazards.</li>
</ul>
<section id="wealth-inequality" class="level2">
<h2 class="anchored" data-anchor-id="wealth-inequality">Wealth inequality</h2>
<p>6 -</p>
<p>They underly the fact that U.S. wealth inequalities have exploded recently, and define three ways of wealth accumulation : 1. Wages in the short term. 2. Investment (linked to RoI) in the long term. 3. Intergenerational transfers at the life term. They point out that wealth has major effect on several other variables, such as (1) education performances, education inequalities, (2) physical health, and (3) emotional well-being. They explain that income and wages have strongly decreased for middle and low wage workes.</p>
<p>7 - About Investment and Long term factors of wealth accumulaition, the authors point out the role of the real estate markets in the increase of inequalities.</p>
<p>8 - Finally, the differences of interest rates on loans have strongly risen, and play a big role in wealth inequality, especially with the 2008 crisis that affected poor people more strongly.</p>
<p>9 - Globally, wealth inequality has strongly icnreased at the extremities of the wealth distribution, and policies have also participated to that.</p>
</section>
<section id="natural-hazard-and-wealth-inequality" class="level2">
<h2 class="anchored" data-anchor-id="natural-hazard-and-wealth-inequality">Natural Hazard and Wealth Inequality</h2>
<p>10 - In this paper, they put the focus on natural hazard with physical damage on property and assets, which can be public or private. Historically, they identify the year of 1755, with the earthbreak in Lisboa, as the begin of the development of an answer from the State.</p>
<p>11 - In the US, the insurance against natural hazard from the State begins in the early 1800s, with 1803 tariffs to help victimes of fire damages. In 1811 and 1812, lands are freely given to victims of displacement, and in the 1830s, there exists a de facto policy of federal disaster assistance. In 1950, there is the Disaster Relief Act (DRA), that is the main milestone for the n.h. protection policy in the US. It allows for : 1) Immediate relief (though housing notably) 2) hazard insurance programs 3) rebuilding damaged infrastructure 4) low-interest loans.</p>
<p>12 - Under other institutions, the authors identify the Federal Emergency Management Agency (FEMA), that is responsible for redistribution of money in n.h. cases, and the National Flood Insurance Program (NFIP), the biggest hazard insurer of the US. Also, there is the private sector of insurance.</p>
<p>13 - The author underline the fact that private and public assistance are focused on restoration of property and wealth, which implies differences in recovery rate and quality in function of the initial wealth of the insured people. Notably, the mention that research has found that poor and non-property owners people are more exposed to risks such as : 1) job loss 2) Having to move (displacement) 3) Having to pay a higher rent, 4) Experimenting a decrease in savings.</p>
<p>14 - They mention the fact that in some natural hazards cases, there is often a reduction or a suspension in labor quality protection policies, and they give the example of regulation suspension after Katrina.</p>
</section>
<section id="research-design" class="level2">
<h2 class="anchored" data-anchor-id="research-design">Research Design</h2>
<p>15 - The authors then present their research design. They use panel data, to study the effect of NH damage on welath distribution. This effect differs in function of considered population, and vary especially strongly when race, education level, and ownership are considered.</p>
<p>16 - The paper also inquires about two main hypothesis : 1) PRivate insurance does not totally prevent increase in wealth inequality from NH damages. 2) the FEMA aid (in net terms) differs in population and contributes to wealth inequality.</p>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<p>17 - The authors now present the used data. THey begin with the Panel Study of Income Dynamics (PSID), a panel dataset that track US families from a “representative sample” from 1968 to now, with information on county and neighbourhood information.</p>
<p>18 - They also use the Spatial Hazard Events and Losses Database (SHELD), that is maintained by the Hazards and Vulnerability Research Institute (HVRI) since 1960 until now. In this dataset, 18 types of natural hazards and their link with (1) fatalities and (2) property damages, are taken into account.</p>
<p>19 - They also make use of the Devennial Census Long form for contextualization.</p>
<p>20 - They finally use the FEMA Projects Summary.</p>
</section>
<section id="measurement" class="level2">
<h2 class="anchored" data-anchor-id="measurement">Measurement</h2>
<section id="wealth-trajectories" class="level3">
<h3 class="anchored" data-anchor-id="wealth-trajectories">Wealth Trajectories</h3>
<p>21 - The define Wealth as in the PSID dataset, where it is the sum, at the close family level*, of = - Saving accounts, - Checking accounts, - Real estate holdings, - Equity, - Vehicles, - Farms, - Businesses, - Stocks, - Annuities / IRAs, - Minus all reported debts.</p>
<p>The distribution they get of the wealth is right-skewed, i.e.&nbsp;inflated by the very rich. To work with the data, they : 1) added a “global minimum” to all raw data, to avoid negative values, and the used the squared root to compress the different wealth levels, 2) they transformed the data to get a normal distribution.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Table_1.png" class="img-fluid figure-img"></p>
<figcaption>TABLE 1.</figcaption>
</figure>
</div>
</section>
<section id="natural-hazard-damages" class="level3">
<h3 class="anchored" data-anchor-id="natural-hazard-damages">Natural Hazard Damages</h3>
<p>22 - In the SHELDUS dataset, the natural hazards damages correspond to the “direct damage to (non-crop) property” variable, in dollars. They standardize it to the 2012 U.S. dollar value, and apply the natural log to get the levels of damages.</p>
</section>
<section id="other-key-variables" class="level3">
<h3 class="anchored" data-anchor-id="other-key-variables">Other Key Variables</h3>
<p>23 - The authors underline the fact that some other key variables have to be taken into account. They identify three main dimensions of social stratification : 1) race (4 mutually exclusive categories : white, black, latino (or hispanic), and “other”), 2) education (in number of total years of school completed, and 3) homeowner status (1 or 0).</p>
<p>24 - To get the private insurance investment, they compute the sum of all premium paid for home and car coverage during the interview year. They do not have more data, although it would be better.</p>
<p>25 - To get the Federal Assistance variable, they sum the non fire related FEMA aid. Here the authors detail a bit the aid asking process. First, when a natural hazard is too big to be handled by the county or the state, they ask the federal authorities. If the President declare the existence of a major disaster, the FEMA then takes action and does money transfers and other kinds of help, such as : financial help, temporary housing, house voucher, uninsured personal needs, and even direct replacement of private property sometimes.</p>
</section>
<section id="control-variables" class="level3">
<h3 class="anchored" data-anchor-id="control-variables">Control Variables</h3>
<p>They also include several control variables, at three main levels : the individual, the neighhorhood, and the population.</p>
<p>26 - The individual level variables are : age, foreign birth, marital status, and number of children under 18 years old who are living within the household, and if the individuals have moved in the last two years.</p>
<p>27 - The variables at the neighborhood level are : the median income of the neighborhood, the number of adults with at least a bachelor degree, and the number of adults currently employed.</p>
<p>28 - Finally, the variables at the population level are the total population, and the ubran-rural variable from 1 to 9.</p>
</section>
</section>
<section id="sampling-and-modeling" class="level2">
<h2 class="anchored" data-anchor-id="sampling-and-modeling">Sampling and Modeling</h2>
<p>29 - Historically, the choice of following the “head of the household” led to only men in the samples, which biased the data from the difference in marital status.</p>
<p>30 - THe author did run one model per gender in the household, but due to very similar results, they only present the female model with at least four over seven interviews.</p>
<p>31-32 - Econometrics things.</p>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>32 -</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>